<!DOCTYPE html>
<html lang="ko" id="top">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ëƒ ëƒ ë…¸íŠ¸ - ë ˆì‹œí”¼ ê²€ìƒ‰ ê²°ê³¼</title>
    <link rel="stylesheet" href="11_ì¸ê³µë ìš©ì§€ëŠ¥_NamyamNote_style.css" />
  </head>

  <body>
    <nav class="site-nav">
      <div class="container nav-top-center">
        <div class="nav-center-box">
          <a href="11_ì¸ê³µë ìš©ì§€ëŠ¥_main.html" aria-label="ëƒ ëƒ ë…¸íŠ¸ í™ˆ">
            <img src="11_logo.png" alt="ëƒ ëƒ ë…¸íŠ¸ ë¡œê³ " class="logo" />
          </a>

          <div class="nav-search">
            <input
              type="text"
              placeholder="ì¬ë£Œëª…ìœ¼ë¡œ ë ˆì‹œí”¼ ê²€ìƒ‰"
              class="nav-search-input"
            />
            <button class="nav-search-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <circle cx="11" cy="11" r="7" stroke="white" stroke-width="2" />
                <line x1="16.5" y1="16.5" x2="21" y2="21" stroke="white" stroke-width="2" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="nav-menu-bar">
        <a class="nav-link" href="11_ì¸ê³µë ìš©ì§€ëŠ¥_main.html">í™ˆ</a>
        <a class="nav-link" href="11_ì¸ê³µë ìš©ì§€ëŠ¥_menulist.html">ë ˆì‹œí”¼</a>
        <a class="nav-link" href="11_ì¸ê³µë ìš©ì§€ëŠ¥_register.html">ë“±ë¡</a>
        <a class="nav-link" href="11_ì¸ê³µë ìš©ì§€ëŠ¥_rank.html">ë­í‚¹</a>
        <a class="nav-link" href="11_ì¸ê³µë ìš©ì§€ëŠ¥_mypage.html">ë§ˆì´í˜ì´ì§€</a>
      </div>
    </nav>

    <main class="page-pad">
      <div id="ranking" class="container">
        <header class="hero center">
          <h1 class="mt-0">
            <span id="keyword-text"></span> ê²€ìƒ‰ ê²°ê³¼
          </h1>
          <p style="font-size: 14px; color: var(--muted)">
            ì´ <span id="result-count">0</span>ê°œì˜ ë ˆì‹œí”¼ë¥¼ ì°¾ì•˜ì–´ìš”.
          </p>
        </header>

        <h2 class="section-title">ê²€ìƒ‰ëœ ë ˆì‹œí”¼</h2>

        <div id="search-result" class="ranking-list mt-20"></div>
      </div>
    </main>

    <a href="#top" class="to-top">ë§¨ ìœ„ë¡œ â†‘</a>

    <script>
      const RECIPES_KEY = "nn_recipes";
      const JSON_PATH = "11_ì¸ê³µë ìš©ì§€ëŠ¥_recipes.json";

      const params = new URLSearchParams(window.location.search);
      const keywordRaw = (params.get("keyword") || "").trim();
      const keyword = keywordRaw.toLowerCase();

      const navInput = document.querySelector(".nav-search-input");
      const navBtn = document.querySelector(".nav-search-btn");
      if (navInput) navInput.value = keywordRaw;

      document.getElementById("keyword-text").textContent =
        keywordRaw ? `"${keywordRaw}"` : "ì „ì²´";

      const resultCountEl = document.getElementById("result-count");
      const resultBox = document.getElementById("search-result");

      /* ğŸ”¸ ë¦¬ë·° ì •ë³´ë§Œ ê¸°ì¤€ìœ¼ë¡œ ë³„ì /ë¦¬ë·° ìˆ˜ ê³„ì‚° */
      function getReviewStats(id) {
        const key = "nn_reviews_" + id;
        try {
          const raw = localStorage.getItem(key);
          if (!raw) {
            return { avg: 0, count: 0 };
          }
          const list = JSON.parse(raw);
          if (!Array.isArray(list) || list.length === 0) {
            return { avg: 0, count: 0 };
          }
          const sum = list.reduce((acc, cur) => acc + (cur.rating || 0), 0);
          const avg = sum / list.length;
          return { avg, count: list.length };
        } catch (e) {
          console.error("ë¦¬ë·° íŒŒì‹± ì˜¤ë¥˜:", e);
          return { avg: 0, count: 0 };
        }
      }

      /* ë¡œì»¬ ì €ì¥ ë ˆì‹œí”¼ */
      function loadLocalRecipes() {
        try {
          const raw = localStorage.getItem(RECIPES_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
          console.error("ë¡œì»¬ ë ˆì‹œí”¼ íŒŒì‹± ì˜¤ë¥˜:", e);
          return [];
        }
      }

      /* JSON ë ˆì‹œí”¼ */
      function loadJsonRecipes() {
        return fetch(JSON_PATH)
          .then((res) => {
            if (!res.ok) throw new Error("JSON ë¡œë“œ ì‹¤íŒ¨");
            return res.json();
          })
          .then((data) => (Array.isArray(data.recipes) ? data.recipes : []))
          .catch((e) => {
            console.error("JSON ë ˆì‹œí”¼ ë¡œë”© ì˜¤ë¥˜:", e);
            return [];
          });
      }

      /* ì¬ë£Œ í…ìŠ¤íŠ¸ ë½‘ê¸° (ê²€ìƒ‰ìš©) */
      function getIngredientText(recipe) {
        const result = [];

        const req = recipe.ingredients_required || recipe.ingredientsRequired;
        const opt = recipe.ingredients_optional || recipe.ingredientsOptional;

        if (Array.isArray(req)) {
          req.forEach((ing) => ing?.name && result.push(String(ing.name)));
        }
        if (Array.isArray(opt)) {
          opt.forEach((ing) => ing?.name && result.push(String(ing.name)));
        }

        if (typeof recipe.ingredients === "string") {
          result.push(recipe.ingredients);
        }

        return result.join(", ").toLowerCase();
      }

      /* í‚¤ì›Œë“œë¡œ í•„í„°ë§ */
      function filterRecipes(list, keyword) {
        if (!keyword) return list;

        return list.filter((r) => {
          const t = (r.title || "").toLowerCase();
          const c = (r.category || "").toLowerCase();
          const s = (r.summary || "").toLowerCase();
          const ing = getIngredientText(r);

          return (
            t.includes(keyword) ||
            c.includes(keyword) ||
            s.includes(keyword) ||
            ing.includes(keyword)
          );
        });
      }

      /* ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§ */
      function renderSearchResult(found) {
        resultCountEl.textContent = found.length;

        if (found.length === 0) {
          resultBox.innerHTML = `
            <div class="card-box mt-20 center">
              <p class="card-title-lg">"${keywordRaw}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              <p style="font-size:14px; color:var(--muted); margin-top:8px;">
                ë‹¤ë¥¸ ì¬ë£Œëª…ì´ë‚˜ ìš”ë¦¬ ì´ë¦„ìœ¼ë¡œ ë‹¤ì‹œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.
              </p>
            </div>`;
          return;
        }

        resultBox.innerHTML = found
          .map((r) => {
            const idStr = String(r.id);
            const link = `11_ì¸ê³µë ìš©ì§€ëŠ¥_recipe.html?id=${encodeURIComponent(
              idStr
            )}`;

            const thumb = r.thumbnail || r.image || "11_default.png";

            const { avg, count } = getReviewStats(idStr);
            const ratingText = avg.toFixed(1); // ë¦¬ë·° ì—†ìœ¼ë©´ 0.0
            const views = r.review_count ?? r.views ?? 0;

            return `
              <a href="${link}" class="rank-card">
                <img
                  src="${thumb}"
                  class="rank-card-image"
                  alt="${r.title || "ë ˆì‹œí”¼ ì´ë¯¸ì§€"}"
                />

                <div class="rank-info">
                  <h2 class="rank-title">${r.title || "ì œëª© ì—†ëŠ” ë ˆì‹œí”¼"}</h2>
                  <p class="rank-description">${r.category || "ê¸°íƒ€"}</p>
                </div>

                <div class="rank-meta">
                  <div class="rank-rating">â˜… ${ratingText}</div>
                  <p class="rank-views">ë¦¬ë·° ${count}ê°œ Â· ì¡°íšŒìˆ˜ ${views}</p>
                </div>
              </a>
            `;
          })
          .join("");
      }

      /* ì´ˆê¸° ê²€ìƒ‰ ì‹¤í–‰ */
      (async function initSearch() {
        try {
          const [jsonRecipes, localRecipes] = await Promise.all([
            loadJsonRecipes(),
            Promise.resolve(loadLocalRecipes()),
          ]);

          const merged = {};
          jsonRecipes.forEach((r) => {
            if (!r || r.id == null) return;
            merged[String(r.id)] = r;
          });
          localRecipes.forEach((r) => {
            if (!r || r.id == null) return;
            merged[String(r.id)] = r;
          });

          const allRecipes = Object.values(merged);
          const found = filterRecipes(allRecipes, keyword);

          renderSearchResult(found);
        } catch (e) {
          console.error("ê²€ìƒ‰ ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
          resultBox.innerHTML = `
            <div class="card-box mt-20 center">
              <p class="card-title-lg">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
              <p style="font-size:14px; color:var(--muted); margin-top:8px;">
                ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.
              </p>
            </div>`;
        }
      })();

      /* ìƒë‹¨ ê²€ìƒ‰ì°½ ë™ì‘ */
      if (navBtn && navInput) {
        navBtn.addEventListener("click", () => {
          const kw = navInput.value.trim();
          if (!kw) {
            alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
          }
          location.href =
            "11_ì¸ê³µë ìš©ì§€ëŠ¥_search.html?keyword=" +
            encodeURIComponent(kw);
        });

        navInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") navBtn.click();
        });
      }
    </script>
  </body>
</html>
