<!DOCTYPE html>
<html lang="ko" id="top">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>냠냠노트 - 레시피 검색 결과</title>
    <link rel="stylesheet" href="11_인공띠용지능_NamyamNote_style.css" />
  </head>

  <body>
    <nav class="site-nav">
      <div class="container nav-top-center">
        <div class="nav-center-box">
          <a href="11_인공띠용지능_main.html" aria-label="냠냠노트 홈">
            <img src="11_logo.png" alt="냠냠노트 로고" class="logo" />
          </a>

          <div class="nav-search">
            <input
              type="text"
              placeholder="재료명으로 레시피 검색"
              class="nav-search-input"
            />
            <button class="nav-search-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <circle cx="11" cy="11" r="7" stroke="white" stroke-width="2" />
                <line
                  x1="16.5"
                  y1="16.5"
                  x2="21"
                  y2="21"
                  stroke="white"
                  stroke-width="2"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="nav-menu-bar">
        <a class="nav-link" href="11_인공띠용지능_main.html">홈</a>
        <a class="nav-link" href="11_인공띠용지능_menulist.html">레시피</a>
        <a class="nav-link" href="11_인공띠용지능_register.html">등록</a>
        <a class="nav-link" href="11_인공띠용지능_rank.html">랭킹</a>
        <a class="nav-link" href="11_인공띠용지능_mypage.html">마이페이지</a>
      </div>
    </nav>

    <main class="page-pad">
      <div id="ranking" class="container">
        <header class="hero center">
          <h1 class="mt-0"><span id="keyword-text"></span> 검색 결과</h1>
          <p style="font-size: 14px; color: var(--muted)">
            총 <span id="result-count">0</span>개의 레시피를 찾았어요.
          </p>
        </header>

        <h2 class="section-title">검색된 레시피</h2>

        <div id="search-result" class="ranking-list mt-20"></div>
      </div>
    </main>

    <a href="#top" class="to-top">맨 위로 ↑</a>

    <script>
      const RECIPES_KEY = 'nn_recipes';
      const JSON_PATH = '11_인공띠용지능_recipes.json';

      const params = new URLSearchParams(window.location.search);
      const keywordRaw = (params.get('keyword') || '').trim();
      const keyword = keywordRaw.toLowerCase();

      const navInput = document.querySelector('.nav-search-input');
      const navBtn = document.querySelector('.nav-search-btn');
      if (navInput) navInput.value = keywordRaw;

      document.getElementById('keyword-text').textContent = keywordRaw
        ? `"${keywordRaw}"`
        : '전체';

      const resultCountEl = document.getElementById('result-count');
      const resultBox = document.getElementById('search-result');

      function getReviewStats(id) {
        const key = 'nn_reviews_' + id;
        try {
          const raw = localStorage.getItem(key);
          if (!raw) {
            return { avg: 0, count: 0 };
          }
          const list = JSON.parse(raw);
          if (!Array.isArray(list) || list.length === 0) {
            return { avg: 0, count: 0 };
          }
          const sum = list.reduce((acc, cur) => acc + (cur.rating || 0), 0);
          const avg = sum / list.length;
          return { avg, count: list.length };
        } catch (e) {
          console.error('리뷰 파싱 오류:', e);
          return { avg: 0, count: 0 };
        }
      }

      function loadLocalRecipes() {
        try {
          const raw = localStorage.getItem(RECIPES_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
          console.error('로컬 레시피 파싱 오류:', e);
          return [];
        }
      }

      function loadJsonRecipes() {
        return fetch(JSON_PATH)
          .then((res) => {
            if (!res.ok) throw new Error('JSON 로드 실패');
            return res.json();
          })
          .then((data) => (Array.isArray(data.recipes) ? data.recipes : []))
          .catch((e) => {
            console.error('JSON 레시피 로딩 오류:', e);
            return [];
          });
      }

      function getIngredientText(recipe) {
        const result = [];

        const req = recipe.ingredients_required || recipe.ingredientsRequired;
        const opt = recipe.ingredients_optional || recipe.ingredientsOptional;

        if (Array.isArray(req)) {
          req.forEach((ing) => ing?.name && result.push(String(ing.name)));
        }
        if (Array.isArray(opt)) {
          opt.forEach((ing) => ing?.name && result.push(String(ing.name)));
        }

        if (typeof recipe.ingredients === 'string') {
          result.push(recipe.ingredients);
        }

        return result.join(', ').toLowerCase();
      }

      function filterRecipes(list, keyword) {
        if (!keyword) return list;

        return list.filter((r) => {
          const t = (r.title || '').toLowerCase();
          const c = (r.category || '').toLowerCase();
          const s = (r.summary || '').toLowerCase();
          const ing = getIngredientText(r);

          return (
            t.includes(keyword) ||
            c.includes(keyword) ||
            s.includes(keyword) ||
            ing.includes(keyword)
          );
        });
      }

      function renderSearchResult(found) {
        resultCountEl.textContent = found.length;

        if (found.length === 0) {
          resultBox.innerHTML = `
            <div class="card-box mt-20 center">
              <p class="card-title-lg">"${keywordRaw}"에 대한 검색 결과가 없습니다.</p>
              <p style="font-size:14px; color:var(--muted); margin-top:8px;">
                다른 재료명이나 요리 이름으로 다시 검색해보세요.
              </p>
            </div>`;
          return;
        }

        resultBox.innerHTML = found
          .map((r) => {
            const idStr = String(r.id);
            const link = `11_인공띠용지능_recipe.html?id=${encodeURIComponent(
              idStr
            )}`;

            const thumb = r.thumbnail || r.image || '11_default.png';

            const { avg, count } = getReviewStats(idStr);
            const ratingText = avg.toFixed(1); // 리뷰 없으면 0.0
            const views = r.review_count ?? r.views ?? 0;

            return `
              <a href="${link}" class="rank-card">
                <img
                  src="${thumb}"
                  class="rank-card-image"
                  alt="${r.title || '레시피 이미지'}"
                />

                <div class="rank-info">
                  <h2 class="rank-title">${r.title || '제목 없는 레시피'}</h2>
                  <p class="rank-description">${r.category || '기타'}</p>
                </div>

                <div class="rank-meta">
                  <div class="rank-rating">★ ${ratingText}</div>
                  <p class="rank-views">리뷰 ${count}개 · 조회수 ${views}</p>
                </div>
              </a>
            `;
          })
          .join('');
      }

      (async function initSearch() {
        try {
          const [jsonRecipes, localRecipes] = await Promise.all([
            loadJsonRecipes(),
            Promise.resolve(loadLocalRecipes()),
          ]);

          const merged = {};
          jsonRecipes.forEach((r) => {
            if (!r || r.id == null) return;
            merged[String(r.id)] = r;
          });
          localRecipes.forEach((r) => {
            if (!r || r.id == null) return;
            merged[String(r.id)] = r;
          });

          const allRecipes = Object.values(merged);
          const found = filterRecipes(allRecipes, keyword);

          renderSearchResult(found);
        } catch (e) {
          console.error('검색 초기화 오류:', e);
          resultBox.innerHTML = `
            <div class="card-box mt-20 center">
              <p class="card-title-lg">검색 중 오류가 발생했습니다.</p>
              <p style="font-size:14px; color:var(--muted); margin-top:8px;">
                잠시 후 다시 시도해 주세요.
              </p>
            </div>`;
        }
      })();

      if (navBtn && navInput) {
        navBtn.addEventListener('click', () => {
          const kw = navInput.value.trim();
          if (!kw) {
            alert('검색어를 입력해주세요!');
            return;
          }
          location.href =
            '11_인공띠용지능_search.html?keyword=' + encodeURIComponent(kw);
        });

        navInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') navBtn.click();
        });
      }
    </script>
  </body>
</html>
