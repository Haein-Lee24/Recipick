<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>레시피 전체보기</title>
    <link rel="stylesheet" href="11_인공띠용지능_NamyamNote_style.css" />

    <style>
      main {
        margin-top: 40px;
      }

      .header-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 60px;
        margin-bottom: 2px;
      }

      .header-area h2 {
        text-align: center;
        font-size: 24px;
        padding-bottom: 20px;
        border-bottom: 1px solid #ded3c4 !important;
        width: 100%;
      }

      .section-title {
        border-bottom: none !important;
      }

      .header-controls {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .back-btn {
        padding: 8px 20px;
        background: #eee;
        border-radius: 80px;
        text-decoration: none;
        color: #333;
        font-size: 14px;
      }

      .sort-area {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 30px;
      }
    </style>
  </head>

  <body>
    <nav class="site-nav">
      <div class="container nav-top-center">
        <div class="nav-center-box">
          <a href="11_인공띠용지능_main.html" aria-label="냠냠노트 홈">
            <img src="11_logo.png" alt="냠냠노트 로고" class="logo" />
          </a>

          <div class="nav-search">
            <input
              type="text"
              placeholder="재료명으로 레시피 검색"
              class="nav-search-input"
            />
            <button class="nav-search-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <circle cx="11" cy="11" r="7" stroke="white" stroke-width="2" />
                <line
                  x1="16.5"
                  y1="16.5"
                  x2="21"
                  y2="21"
                  stroke="white"
                  stroke-width="2"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="nav-menu-bar">
        <a class="nav-link" href="11_인공띠용지능_main.html">홈</a>
        <a class="nav-link" href="11_인공띠용지능_menulist.html">레시피</a>
        <a class="nav-link" href="11_인공띠용지능_register.html">등록</a>
        <a class="nav-link" href="11_인공띠용지능_rank.html">랭킹</a>
        <a class="nav-link" href="11_인공띠용지능_mypage.html">마이페이지</a>
      </div>
    </nav>

    <main class="container page-pad">
      <div class="header-area">
        <h2 id="full-title" class="section-title">로딩 중...</h2>

        <div class="header-controls">
          <a href="11_인공띠용지능_menulist.html" class="back-btn">
            ← 카테고리별 목록으로
          </a>

          <div class="sort-area">
            <label for="sort-select">정렬:</label>
            <select id="sort-select">
              <option value="name">이름순(기본)</option>
              <option value="views">인기순(조회수 많은순)</option>
              <option value="rating">평점 높은순</option>
            </select>
          </div>
        </div>
      </div>

      <div id="full-list" class="card-grid"></div>
    </main>

    <script>
      const params = new URLSearchParams(window.location.search);
      const currentCategory = params.get("category");

      const categoryMap = {
        korean: "한식",
        western: "양식",
        chinese: "중식",
        dessert: "디저트",
        drink: "음료",
      };

      const STORAGE_KEY = "nn_recipes";

      function getDefaultImage(cat) {
        switch (cat) {
          case "한식":
            return "11_kimchi.jpg";
          case "양식":
            return "11_pasta.jpg";
          case "중식":
            return "11_chinese.png";
          case "디저트":
            return "11_snack.jpg";
          case "음료":
            return "11_drink.png";
          default:
            return "11_pasta.jpg";
        }
      }

      /* ----------------------------
          ⭐ 리뷰/별점 관련 공통함수
      ------------------------------ */

      function getReviews(id) {
        return JSON.parse(localStorage.getItem("nn_reviews_" + id) || "[]");
      }

      function getAvgRating(id) {
        const list = getReviews(id);
        if (list.length === 0) return 0;
        const sum = list.reduce((a, b) => a + Number(b.rating), 0);
        return sum / list.length;
      }

      function getReviewCount(id) {
        return getReviews(id).length;
      }

      function loadUserRecipes(targetName, isDessertMode) {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const all = JSON.parse(raw);
          return all.filter((u) => {
            if (isDessertMode)
              return u.category === "디저트" || u.category === "간식";
            return u.category === targetName;
          });
        } catch {
          return [];
        }
      }

      function makeCardHTML(title, thumbnail, metaText, ratingText, href) {
        return `
          <a href="${href}" class="card">
            <img src="${thumbnail}" alt="${title}" class="thumb" />
            <div class="card-body">
              <p class="card-title">${title}</p>
              <p class="recipe-meta">${metaText}</p>
              <div class="rating">${ratingText}</div>
            </div>
          </a>
        `;
      }

      /* ----------------------------
          ⭐ 메인 렌더링
      ------------------------------ */

      fetch("11_인공띠용지능_recipes.json")
        .then((res) => res.json())
        .then((data) => {
          const titleEl = document.getElementById("full-title");
          const listEl = document.getElementById("full-list");
          const sortSelect = document.getElementById("sort-select");

          const targetName = categoryMap[currentCategory];
          if (!targetName) {
            titleEl.innerText = "잘못된 카테고리입니다.";
            return;
          }

          const isDessertMode = currentCategory === "dessert";

          const jsonRecipes = data.recipes.filter((r) => {
            if (isDessertMode)
              return r.category === "디저트" || r.category === "간식";
            return r.category === targetName;
          });

          const userRecipes = loadUserRecipes(targetName, isDessertMode);

          let fullList = [...jsonRecipes, ...userRecipes];

          fullList = fullList.map((r) => {
            const isUserRecipe = !!r.authorName;

            return {
              ...r,
              rating: getAvgRating(r.id),
              review_count: isUserRecipe
                ? getReviewCount(r.id)
                : r.review_count,
              authorName: r.authorName || "냠냠이",
            };
          });

          titleEl.innerText = `전체 ${targetName} 레시피 (총 ${fullList.length}개)`;

          function ratingText(r) {
            return "★ " + (r.rating?.toFixed(1) || "0.0");
          }

          function sortList(type) {
            if (type === "name") {
              fullList.sort((a, b) =>
                a.title.localeCompare(b.title, "ko-KR")
              );
            }
            if (type === "views") {
              fullList.sort((a, b) => b.review_count - a.review_count);
            }
            if (type === "rating") {
              fullList.sort((a, b) => b.rating - a.rating);
            }
            render();
          }

          function render() {
            listEl.innerHTML = fullList
              .map((r) => {
                const href = `11_인공띠용지능_recipe.html?id=${r.id}`;
                const thumb =
                  r.thumbnail || r.image || getDefaultImage(r.category);

                const meta = `작성자: ${r.authorName} · 조회수 ${r.review_count}`;
                return makeCardHTML(
                  r.title,
                  thumb,
                  meta,
                  ratingText(r),
                  href
                );
              })
              .join("");
          }

          sortList("name");

          sortSelect.addEventListener("change", () => {
            sortList(sortSelect.value);
          });
        });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const navInput = document.querySelector(".nav-search-input");
        const navBtn = document.querySelector(".nav-search-btn");

        if (!navInput || !navBtn) return;

        navBtn.addEventListener("click", () => {
          const kw = navInput.value.trim();
          if (!kw) {
            alert("검색어를 입력해주세요!");
            return;
          }

          location.href =
            "11_인공띠용지능_search.html?keyword=" +
            encodeURIComponent(kw);
        });

        navInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") navBtn.click();
        });
      });
    </script>
  </body>
</html>
