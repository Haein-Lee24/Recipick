<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>레시피 전체보기</title>
    <link rel="stylesheet" href="11_인공띠용지능_NamyamNote_style.css" />

    <style>
      /* 상단 영역 및 뒤로가기 버튼 스타일 */
      main {
        margin-top: 40px;
      }
      .header-area {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: none !important;
      }
      .back-btn {
        padding: 8px 16px;
        background: #eee;
        border-radius: 8px;
        text-decoration: none;
        color: #333;
        font-size: 14px;
      }
    </style>
  </head>

  <body>
    <!-- 사이트 공통 네비게이션 -->
    <nav class="site-nav">
      <div class="container nav-inner">
        <div class="logo-area">
          <a href="11_인공띠용지능_main.html">
            <img src="11_logo.png" alt="Logo" class="logo" />
          </a>
        </div>
        <div class="menu">
          <a class="nav-link" href="11_인공띠용지능_main.html">홈</a>
          <a class="active nav-link" href="11_인공띠용지능_menulist.html">레시피</a>
          <a class="nav-link" href="11_인공띠용지능_register.html">등록</a>
          <a class="nav-link" href="11_인공띠용지능_rank.html">랭킹</a>
          <a class="nav-link" href="11_인공띠용지능_mypage.html">마이페이지</a>
        </div>
      </div>
    </nav>

    <main class="container page-pad">
      <!-- 제목 + 뒤로가기 버튼 -->
      <div class="header-area">
        <h2 id="full-title" class="section-title">로딩 중...</h2>
        <a href="11_인공띠용지능_menulist.html" class="back-btn">← 목록으로</a>
      </div>

      <!-- 정렬 선택 바 -->
      <div class="sort-bar" style="margin-bottom: 20px;">
        <label for="sort-select" style="margin-right: 8px; font-weight: 600;">정렬:</label>
        <select id="sort-select" style="padding: 6px 10px; border-radius: 6px;">
          <option value="name">이름순(가나다순)</option>
          <option value="views">인기순(조회수 많은순)</option>
          <option value="rating">평점 높은순</option>
        </select>
      </div>


      <!-- 레시피 카드 리스트가 출력될 영역 -->
      <div id="full-list" class="card-grid"></div>
    </main>

    <script>
      /* ----------------------------------------
        URL 파라미터에서 category 값 읽기
        ex) ?category=korean, western, dessert 등
      ---------------------------------------- */
      const params = new URLSearchParams(window.location.search);
      const currentCategory = params.get("category");

      /* ----------------------------------------
        JSON 내부 카테고리(한글)와 URL 파라미터(영어) 매핑
      ---------------------------------------- */
      const categoryMap = {
        korean: "한식",
        western: "양식",
        chinese: "중식",
        dessert: "디저트",
        drink: "음료",
      };

      // localStorage key
      const STORAGE_KEY = "nn_recipes";

      /* ----------------------------------------
        카테고리별 기본 이미지 제공 함수
      ---------------------------------------- */
      function getDefaultImage(korCategory) {
        switch (korCategory) {
          case "한식":
            return "11_kimchi.jpg";
          case "양식":
            return "11_pasta.jpg";
          case "중식":
            return "11_chinese.png";
          case "디저트":
            return "11_snack.jpg";
          case "음료":
            return "11_drink.png";
          default:
            return "11_pasta.jpg";
        }
      }

      /* ----------------------------------------
        localStorage에 저장된 사용자 레시피 로드
        - 디저트는 ‘디저트’ + ‘간식’ 모두 포함
      ---------------------------------------- */
      function loadUserRecipes(targetName, isDessertMode) {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];

          const all = JSON.parse(raw);

          return all.filter((u) => {
            if (isDessertMode) {
              return u.category === "디저트" || u.category === "간식";
            }
            return u.category === targetName;
          });
        } catch (e) {
          console.error("유저 레시피 파싱 오류:", e);
          return [];
        }
      }

      /* ----------------------------------------
        카드 HTML 템플릿 생성 함수
      ---------------------------------------- */
      function makeCardHTML(title, thumbnail, metaText, ratingText, href) {
        return `
          <a href="${href}" class="card">
            <img src="${thumbnail}" alt="${title}" class="thumb" />
            <div class="card-body">
              <p class="card-title">${title}</p>
              <p class="recipe-meta">${metaText}</p>
              <div class="rating">${ratingText}</div>
            </div>
          </a>
        `;
      }

      /* ----------------------------------------
        JSON 파일(기본 레시피들) 불러와서 렌더링
      ---------------------------------------- */
      fetch("11_인공띠용지능_recipes.json")
        .then((res) => res.json())
        .then((data) => {
          const titleEl = document.getElementById("full-title");
          const listEl = document.getElementById("full-list");
          const sortSelect = document.getElementById("sort-select");

          const targetName = categoryMap[currentCategory];

    // 잘못된 category 처리
          if (!targetName) {
            titleEl.innerText = "잘못된 카테고리입니다.";
            return;
          }

          const isDessertMode = currentCategory === "dessert";

         /* JSON 레시피 */
          const jsonRecipes = data.recipes.filter((r) => {
            if (isDessertMode)
              return r.category === "디저트" || r.category === "간식";
              return r.category === targetName;
          });

          /* localStorage 레시피 */
          const userRecipes = loadUserRecipes(targetName, isDessertMode);

          /* 전체 리스트 합치기 */
          let fullList = [...jsonRecipes, ...userRecipes];

          /* 제목 표기 */
          titleEl.innerText = `전체 ${targetName} 레시피 (총 ${fullList.length}개)`;

          if (fullList.length === 0) {
            listEl.innerHTML = "<p>등록된 레시피가 없습니다.</p>";
            return;
          }

    /* ------------------------
       정렬 함수
    ------------------------- */
          function sortList(type) {
            if (type === "name") {
              fullList.sort((a, b) => a.title.localeCompare(b.title, "ko-KR"));
          }

          if (type === "views") {
            fullList.sort((a, b) => {
              // JSON: review_count  / user: views
              const A = a.review_count ? Number(a.review_count) : Number(a.views || 0);
              const B = b.review_count ? Number(b.review_count) : Number(b.views || 0);
              return B - A;
            });
          }

          if (type === "rating") {
            fullList.sort((a, b) => {
              const A = Number(a.rating);
              const B = Number(b.rating);
            return B - A;
            });
          }

          renderCards();
        }

    /* ------------------------
       렌더링 함수
    ------------------------- */
        function renderCards() {
          listEl.innerHTML = fullList
            .map((r) => {
              const href = `11_인공띠용지능_recipe.html?id=${r.id}`;
              const thumb = r.thumbnail || r.image || getDefaultImage(r.category);

              const meta = r.review_count
                ? `작성자: 냠냠이 · 리뷰 ${r.review_count}개`
                : `작성자: 사용자 · 조회수 ${r.views || 0}`;

              const rating = `★ ${Number(r.rating).toFixed(1)}`;

              return makeCardHTML(r.title, thumb, meta, rating, href);
            })
            .join("");
        }

    /* ------------------------
       초기 정렬: 이름순
    ------------------------- */
        sortList("name");

    /* ------------------------
       정렬 UI 이벤트 연결
    ------------------------- */
        sortSelect.addEventListener("change", () => {
          sortList(sortSelect.value);
        });
      })
      .catch((err) => console.error("로딩 실패:", err));
    </script>
  </body>
</html>
