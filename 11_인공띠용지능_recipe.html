<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">ëƒ ëƒ ë…¸íŠ¸ - ë ˆì‹œí”¼</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="11_ì¸ê³µë ìš©ì§€ëŠ¥_NamyamNote_style.css" />

    <style>
      /* ë¦¬ë·° í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ì²˜ë¦¬ */
      .review-text {
        white-space: pre-wrap;
        word-break: break-all;
        color: #333;
        margin: 8px 0;
      }
      /* ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ (ì‚¬ì§„ ì°¸ê³ ) */
      .review-card {
        border-bottom: 1px solid #eee;
        padding: 20px 0;
      }
      .review-card:last-child {
        border-bottom: none;
      }
      .rv-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }
      .rv-nickname {
        font-weight: bold;
        font-size: 1rem;
        color: #333;
      }
      .rv-date {
        font-size: 0.8rem;
        color: #999;
      }
    </style>
  </head>

  <body>
    <nav class="site-nav">
      <div class="container nav-inner">
        <div class="logo-area">
          <a href="11_ì¸ê³µë ìš©ì§€ëŠ¥_main.html" class="logo">
            <img src="11_logo.png" alt="ëƒ ëƒ ë…¸íŠ¸ ë¡œê³ " class="logo-img" />
          </a>
        </div>

        <div class="menu">
          <a href="11_ì¸ê³µë ìš©ì§€ëŠ¥_main.html" class="nav-link">í™ˆ</a>
          <a href="11_ì¸ê³µë ìš©ì§€ëŠ¥_menulist.html#all" class="active nav-link"
            >ë ˆì‹œí”¼</a
          >
          <a href="11_ì¸ê³µë ìš©ì§€ëŠ¥_register.html" class="nav-link">ë“±ë¡</a>
          <a href="11_ì¸ê³µë ìš©ì§€ëŠ¥_rank.html#ranking" class="nav-link">ë­í‚¹</a>
          <a href="11_ì¸ê³µë ìš©ì§€ëŠ¥_mypage.html" class="nav-link">ë§ˆì´í˜ì´ì§€</a>
        </div>
      </div>
    </nav>

    <main class="page-pad">
      <div class="container">
        <section class="hero">
          <img
            id="thumb"
            style="
              width: 100%;
              height: 600px;
              object-fit: cover;
              border-radius: 12px;
              background-color: #eee;
            "
          />

          <div>
            <h1 id="recipe-title" style="margin-top: 30px"></h1>
            <p id="recipe-summary" class="mt-20"></p>

            <div class="mt-20">
              <span id="recipe-category" class="badge-green"></span>
              <span>ë‚œì´ë„: <strong id="recipe-difficulty"></strong></span>
              <span>ì¡°ë¦¬ ì‹œê°„: <strong id="recipe-time"></strong></span>
            </div>

            <div
              id="recipe-rating-summary"
              class="rating"
              style="margin-top: 15px; font-size: 1.1rem"
            ></div>

            <div class="btn-row">
              <button class="btn-solid" id="btn-save">
                <i class="fas fa-heart"></i> ì €ì¥í•˜ê¸°
              </button>

              <button class="btn-outline" id="btn-share">
                <i class="fas fa-share-alt"></i> ê³µìœ 
              </button>
            </div>
          </div>
        </section>

        <div class="grid-2 gap-24 mt-80">
          <section class="card-box">
            <h2 class="card-title-lg">í•„ìˆ˜ ì¬ë£Œ</h2>
            <ul id="ingredients-required" class="list-v"></ul>

            <h3 class="section-title mt-20">ì„ íƒ ì¬ë£Œ</h3>
            <ul id="ingredients-optional" class="list-v"></ul>
          </section>

          <section class="card-box">
            <h2 class="card-title-lg">ì¡°ë¦¬ ê³¼ì •</h2>
            <ol id="recipe-steps" class="list-v"></ol>
          </section>
        </div>

        <section class="card-box mt-80">
          <h2 id="review-section-title" class="card-title-lg">ë¦¬ë·° (0ê°œ)</h2>

          <div class="review-area">
            <div class="review-input-box">
              <textarea
                id="review-content"
                class="input-text"
                placeholder="ì´ ë ˆì‹œí”¼ì— ëŒ€í•œ ë‹¹ì‹ ì˜ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!"
              ></textarea>

              <div class="btn-row between">
                <div class="rating-stars" id="star-container">
                  <i class="far fa-star" data-score="1"></i>
                  <i class="far fa-star" data-score="2"></i>
                  <i class="far fa-star" data-score="3"></i>
                  <i class="far fa-star" data-score="4"></i>
                  <i class="far fa-star" data-score="5"></i>
                </div>

                <button class="btn-solid" id="btn-submit-review">
                  ë¦¬ë·° ë“±ë¡
                </button>
              </div>
            </div>

            <div id="review-list" class="review-list"></div>
          </div>
        </section>
      </div>
    </main>

    <a href="#top" class="to-top">ë§¨ ìœ„ë¡œ â†‘</a>

    <script src="11_ì¸ê³µë ìš©ì§€ëŠ¥_recipeLoader.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // --- DOM ìš”ì†Œ ---
        const reviewInput = document.getElementById('review-content');
        const reviewListEl = document.getElementById('review-list');
        const reviewSubmitBtn = document.getElementById('btn-submit-review');
        const sectionTitle = document.getElementById('review-section-title');
        const ratingSummaryEl = document.getElementById(
          'recipe-rating-summary'
        );
        const starContainer = document.getElementById('star-container');
        const starIcons = starContainer.querySelectorAll('i');

        // --- ë ˆì‹œí”¼ ID í™•ì¸ ---
        const urlParams = new URLSearchParams(window.location.search);
        const recipeId =
          urlParams.get('id') || urlParams.get('recipe') || 'default_recipe';
        const REVIEW_KEY = 'nn_reviews_' + recipeId;

        // --- ìƒíƒœ ë³€ìˆ˜ ---
        let currentSelectedRating = 0;

        // --- ë³„ì  í´ë¦­ ì´ë²¤íŠ¸ ---
        starIcons.forEach((star) => {
          star.style.cursor = 'pointer';
          star.addEventListener('click', function () {
            currentSelectedRating = parseInt(this.getAttribute('data-score'));
            updateStarVisuals(currentSelectedRating);
          });
        });

        function updateStarVisuals(score) {
          starIcons.forEach((icon, index) => {
            if (index < score) {
              icon.classList.remove('far');
              icon.classList.add('fas');
              icon.style.color = '#FFB800';
            } else {
              icon.classList.remove('fas');
              icon.classList.add('far');
              icon.style.color = '#ccc';
            }
          });
        }

        // --- ë°ì´í„° ë¡œë“œ/ì €ì¥ ---
        function loadReviews() {
          try {
            const data = localStorage.getItem(REVIEW_KEY);
            return data ? JSON.parse(data) : [];
          } catch (e) {
            return [];
          }
        }

        function saveReviews(reviews) {
          localStorage.setItem(REVIEW_KEY, JSON.stringify(reviews));
        }

        // --- [í•µì‹¬] ìƒë‹¨ ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸ (ì²«ë²ˆì§¸ ì‚¬ì§„ ê´€ë ¨) ---
        function updateTopSummary(reviews) {
          const totalCount = reviews.length;
          let average = 0;

          if (totalCount > 0) {
            const sum = reviews.reduce((acc, curr) => acc + curr.rating, 0);
            average = (sum / totalCount).toFixed(1); // ì†Œìˆ˜ì  ì²«ì§¸ìë¦¬ê¹Œì§€
          }

          // ë³„ì  HTML ìƒì„± (í‰ê·  ì ìˆ˜ ê¸°ì¤€)
          let starsHtml = '';
          for (let i = 1; i <= 5; i++) {
            if (i <= Math.round(average)) {
              starsHtml += '<i class="fas fa-star" style="color:#FFB800"></i>';
            } else {
              starsHtml += '<i class="far fa-star" style="color:#ccc"></i>';
            }
          }

          // ìƒë‹¨ ìš”ì•½ divì— ê½‚ì•„ë„£ê¸°
          ratingSummaryEl.innerHTML = `
                ${starsHtml}
                <span style="color: #666; font-size: 0.95rem; margin-left: 8px; font-weight: normal;">
                    (${average}ì  / ${totalCount}ê°œ ë¦¬ë·°)
                </span>
            `;

          // í•˜ë‹¨ ë¦¬ë·° ì„¹ì…˜ ì œëª©ë„ ì—…ë°ì´íŠ¸
          sectionTitle.textContent = `ë¦¬ë·° (${totalCount}ê°œ)`;
        }

        // --- [í•µì‹¬] ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ë‘ë²ˆì§¸ ì‚¬ì§„ ìŠ¤íƒ€ì¼ ì ìš©) ---
        function renderReviews() {
          const reviews = loadReviews();

          // ìƒë‹¨ ìš”ì•½ ì •ë³´ë„ ê°™ì´ ê°±ì‹ 
          updateTopSummary(reviews);

          reviewListEl.innerHTML = '';

          if (reviews.length === 0) {
            reviewListEl.innerHTML =
              '<p class="no-review-msg" style="color:#777; padding: 30px 0; text-align:center;">ì²« ë²ˆì§¸ ë¦¬ë·°ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”! ğŸ³</p>';
            return;
          }

          // ìµœì‹ ìˆœ ì •ë ¬
          const sortedReviews = [...reviews].reverse();

          sortedReviews.forEach((rev) => {
            // ë³„ì  ìƒì„±
            let starsHtml = '';
            for (let i = 0; i < 5; i++) {
              starsHtml +=
                i < rev.rating
                  ? '<i class="fas fa-star" style="color:#FFB800; font-size: 0.8rem;"></i>'
                  : '<i class="far fa-star" style="color:#ccc; font-size: 0.8rem;"></i>';
            }

            // ìš”ì†Œ ìƒì„±
            const item = document.createElement('div');
            item.className = 'review-card'; // CSS í´ë˜ìŠ¤ ì ìš©

            // ë‘ ë²ˆì§¸ ì‚¬ì§„ê³¼ ë˜‘ê°™ì€ êµ¬ì¡°ë¡œ HTML ì¡°ë¦½
            item.innerHTML = `
              <div class="rv-header">
                <span class="rv-nickname"></span>
                <span class="rv-stars">${starsHtml}</span>
              </div>
              <div class="review-text"></div>
              <div class="rv-date">${rev.date}</div>
            `;

            // í…ìŠ¤íŠ¸ ì•ˆì „í•˜ê²Œ ë„£ê¸° (XSS ë°©ì§€)
            item.querySelector('.rv-nickname').textContent = rev.nickname;
            item.querySelector('.review-text').textContent = rev.text;

            reviewListEl.appendChild(item);
          });
        }

        // --- ë¦¬ë·° ë“±ë¡ ë¡œì§ ---
        reviewSubmitBtn.addEventListener('click', function () {
          const text = reviewInput.value.trim();

          if (!text) {
            alert('ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
          }
          if (currentSelectedRating === 0) {
            alert('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
            return;
          }

          let nickname = localStorage.getItem('nn_nickname');
          if (!nickname) {
            // ì„ì‹œ ë‹‰ë„¤ì„ ìƒì„± (ì‹¤ì œ êµ¬í˜„ ì‹œ ë¡œê·¸ì¸ ì •ë³´ ì‚¬ìš©)
            nickname = 'Haein_Cook';
            localStorage.setItem('nn_nickname', nickname);
          }

          const today = new Date();
          const dateString =
            today.getFullYear() +
            '-' +
            String(today.getMonth() + 1).padStart(2, '0') +
            '-' +
            String(today.getDate()).padStart(2, '0');

          const newReview = {
            id: Date.now(),
            nickname: nickname,
            text: text,
            rating: currentSelectedRating,
            date: dateString,
          };

          const currentReviews = loadReviews();
          currentReviews.push(newReview);
          saveReviews(currentReviews);

          renderReviews(); // í™”ë©´ ê°±ì‹  (ìƒë‹¨ ì ìˆ˜, ë¦¬ìŠ¤íŠ¸ ëª¨ë‘)

          // ì…ë ¥ì°½ ì´ˆê¸°í™”
          reviewInput.value = '';
          currentSelectedRating = 0;
          updateStarVisuals(0);
        });

        // --- ì´ˆê¸° ì‹¤í–‰ ---
        renderReviews();
      });
    </script>
  </body>
</html>
