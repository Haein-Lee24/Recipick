<!DOCTYPE html>
<html lang="ko" id="top">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">ëƒ ëƒ ë…¸íŠ¸ - ë ˆì‹œí”¼</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="11_ì¸ê³µë ìš©ì§€ëŠ¥_NamyamNote_style.css" />

    <style>
      .review-text {
        white-space: pre-wrap;
        word-break: break-all;
        color: #333;
        margin: 8px 0;
      }
      .review-card {
        border-bottom: 1px solid #eee;
        padding: 20px 0;
      }
      .review-card:last-child {
        border-bottom: none;
      }
      .rv-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }
      .rv-nickname {
        font-weight: bold;
        font-size: 1rem;
        color: #333;
      }
      .rv-date {
        font-size: 0.8rem;
        color: #999;
      }
      .btn-solid.saved {
        background: #4caf50 !important;
        border-color: #4caf50 !important;
      }

      .category-badge {
        display: inline-block;
        padding: 4px 10px;
        font-size: 0.85rem;
        font-weight: 600;
        border-radius: 17px;
        margin-right: 5px;
        border: 1.8px solid transparent;
        background: #ffffffaa;
        backdrop-filter: blur(4px);
      }

      .badge-hansik {
        color: #2f6b4f;
        border-color: #2f6b4f;
        background-color: #e6f3ec;
      }

      .badge-jungsik {
        color: #c62828;
        border-color: #c62828;
        background-color: #fdecea;
      }

      .badge-yangsik {
        color: #3f51b5;
        border-color: #3f51b5;
        background-color: #e7e8f8;
      }

      .badge-dessert {
        color: #ba68c8;
        border-color: #ba68c8;
        background-color: #f6ebf9;
      }

      .badge-beverage {
        color: #4fc3f7;
        border-color: #4fc3f7;
        background-color: #e8f7ff;
      }
    </style>
  </head>

  <body>
    <nav class="site-nav">
      <div class="container nav-inner">
        <div class="logo-area">
          <a href="11_ì¸ê³µë ìš©ì§€ëŠ¥_main.html" class="logo">
            <img src="11_logo.png" alt="ëƒ ëƒ ë…¸íŠ¸ ë¡œê³ " class="logo-img" />
          </a>
        </div>

        <div class="menu">
          <a href="11_ì¸ê³µë ìš©ì§€ëŠ¥_main.html" class="nav-link">í™ˆ</a>
          <a href="11_ì¸ê³µë ìš©ì§€ëŠ¥_menulist.html#all" class="active nav-link"
            >ë ˆì‹œí”¼</a
          >
          <a href="11_ì¸ê³µë ìš©ì§€ëŠ¥_register.html" class="nav-link">ë“±ë¡</a>
          <a href="11_ì¸ê³µë ìš©ì§€ëŠ¥_rank.html#ranking" class="nav-link">ë­í‚¹</a>
          <a href="11_ì¸ê³µë ìš©ì§€ëŠ¥_mypage.html" class="nav-link">ë§ˆì´í˜ì´ì§€</a>
        </div>
      </div>
    </nav>

    <main class="page-pad">
      <div class="container">
        <section class="hero">
          <img
            id="thumb"
            style="
              width: 100%;
              height: 600px;
              object-fit: cover;
              border-radius: 12px;
              background-color: #eee;
            "
          />

          <div>
            <h1 id="recipe-title" style="margin-top: 30px"></h1>
            <p id="recipe-summary" class="mt-20"></p>

            <div class="mt-20">
              <span id="recipe-category"></span>

              <span>ë‚œì´ë„: <strong id="recipe-difficulty"></strong></span>
              <span>ì¡°ë¦¬ ì‹œê°„: <strong id="recipe-time"></strong></span>
            </div>

            <div
              id="recipe-rating-summary"
              class="rating"
              style="margin-top: 15px; font-size: 1.1rem"
            ></div>

            <div class="btn-row">
              <button class="btn-solid" id="btn-save">
                <i class="fas fa-heart"></i> ì €ì¥í•˜ê¸°
              </button>

              <button class="btn-outline" id="btn-share">
                <i class="fas fa-share-alt"></i> ê³µìœ 
              </button>
            </div>
          </div>
        </section>

        <div class="grid-2 gap-24 mt-80">
          <section class="card-box">
            <h2 class="card-title-lg">í•„ìˆ˜ ì¬ë£Œ</h2>
            <ul id="ingredients-required" class="list-v"></ul>

            <h3 class="section-title mt-20">ì„ íƒ ì¬ë£Œ</h3>
            <ul id="ingredients-optional" class="list-v"></ul>
          </section>

          <section class="card-box">
            <h2 class="card-title-lg">ì¡°ë¦¬ ê³¼ì •</h2>
            <ol id="recipe-steps" class="list-v"></ol>
          </section>
        </div>

        <section class="card-box mt-80">
          <h2 id="review-section-title" class="card-title-lg">ë¦¬ë·° (0ê°œ)</h2>

          <div class="review-area">
            <div class="review-input-box">
              <textarea
                id="review-content"
                class="input-text"
                placeholder="ì´ ë ˆì‹œí”¼ì— ëŒ€í•œ ë‹¹ì‹ ì˜ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!"
              ></textarea>

              <div class="btn-row between">
                <div class="rating-stars" id="star-container">
                  <i class="far fa-star" data-score="1"></i>
                  <i class="far fa-star" data-score="2"></i>
                  <i class="far fa-star" data-score="3"></i>
                  <i class="far fa-star" data-score="4"></i>
                  <i class="far fa-star" data-score="5"></i>
                </div>

                <button class="btn-solid" id="btn-submit-review">
                  ë¦¬ë·° ë“±ë¡
                </button>
              </div>
            </div>

            <div id="review-list" class="review-list"></div>
          </div>
        </section>
      </div>
    </main>

    <a href="#top" class="to-top">ë§¨ ìœ„ë¡œ â†‘</a>

    <script src="11_ì¸ê³µë ìš©ì§€ëŠ¥_menulist-data.js"></script>

    <script src="11_ì¸ê³µë ìš©ì§€ëŠ¥_recipeLoader.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // ğŸ”¹ ë¡œê·¸ì¸ ìœ ì € ì •ë³´ (currentUser + users[currentUser]) ì‚¬ìš©
        const currentUser = localStorage.getItem('currentUser');
        const users = JSON.parse(localStorage.getItem('users')) || {};
        const currentUserInfo =
          currentUser && users[currentUser] ? users[currentUser] : null;

        const reviewInput = document.getElementById('review-content');
        const reviewListEl = document.getElementById('review-list');
        const reviewSubmitBtn = document.getElementById('btn-submit-review');
        const sectionTitle = document.getElementById('review-section-title');
        const ratingSummaryEl = document.getElementById(
          'recipe-rating-summary'
        );
        const starContainer = document.getElementById('star-container');
        const starIcons = starContainer.querySelectorAll('i');

        const btnSave = document.getElementById('btn-save');
        const btnShare = document.getElementById('btn-share');

        const urlParams = new URLSearchParams(window.location.search);
        const recipeId =
          urlParams.get('id') || urlParams.get('recipe') || 'default_recipe';

        const REVIEW_KEY = 'nn_reviews_' + recipeId;
        const SAVED_KEY = 'nn_saved_recipes';
        const RECENT_KEY = 'nn_recent_recipes';

        // ğŸ”¹ ìµœê·¼ ë³¸ ë ˆì‹œí”¼ ê¸°ë¡
        setTimeout(() => {
          let recent = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]');

          const obj = {
            id: recipeId,
            title: document.getElementById('recipe-title').textContent,
            summary: document.getElementById('recipe-summary').textContent,
            thumbnail: document.getElementById('thumb').src,
            rating: 0,
            review_count: 0,
            link: `11_ì¸ê³µë ìš©ì§€ëŠ¥_recipe.html?id=${recipeId}`,
          };

          recent = recent.filter((item) => item.id !== recipeId);
          recent.unshift(obj);
          if (recent.length > 20) recent = recent.slice(0, 20);

          localStorage.setItem(RECENT_KEY, JSON.stringify(recent));
        }, 300);

        // =======================
        //   ì €ì¥ ë ˆì‹œí”¼ ì²˜ë¦¬
        // =======================
        function loadSavedList() {
          try {
            const data = localStorage.getItem(SAVED_KEY);
            return data ? JSON.parse(data) : [];
          } catch {
            return [];
          }
        }

        function saveSavedList(list) {
          localStorage.setItem(SAVED_KEY, JSON.stringify(list));
        }

        function updateSaveButton() {
          const savedList = loadSavedList();
          const isSaved = savedList.some((item) => item.id === recipeId);

          if (isSaved) {
            btnSave.innerHTML = '<i class="fas fa-check"></i> ì €ì¥ë¨';
            btnSave.classList.add('saved');
          } else {
            btnSave.innerHTML = '<i class="fas fa-heart"></i> ì €ì¥í•˜ê¸°';
            btnSave.classList.remove('saved');
          }
        }

        btnSave.addEventListener('click', () => {
          let list = loadSavedList();
          const exists = list.some((item) => item.id === recipeId);

          if (exists) {
            list = list.filter((item) => item.id !== recipeId);
          } else {
            const obj = {
              id: recipeId,
              title: document.getElementById('recipe-title').textContent,
              summary: document.getElementById('recipe-summary').textContent,
              thumbnail: document.getElementById('thumb').src,
              rating: 0,
              review_count: 0,
              link: `11_ì¸ê³µë ìš©ì§€ëŠ¥_recipe.html?id=${recipeId}`,
            };
            list.unshift(obj);
          }

          saveSavedList(list);
          updateSaveButton();
        });

        btnShare.addEventListener('click', () => {
          alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆì–´ìš”! ì¹œêµ¬ì—ê²Œ ê³µìœ í•´ë³´ì„¸ìš” ğŸ˜Š');
        });

        // =======================
        //   ë³„ì  ì„ íƒ UI
        // =======================
        let currentSelectedRating = 0;

        starIcons.forEach((star) => {
          star.style.cursor = 'pointer';
          star.addEventListener('click', function () {
            currentSelectedRating = parseInt(this.getAttribute('data-score'));
            updateStarVisuals(currentSelectedRating);
          });
        });

        function updateStarVisuals(score) {
          starIcons.forEach((icon, index) => {
            if (index < score) {
              icon.classList.remove('far');
              icon.classList.add('fas');
              icon.style.color = '#FFB800';
            } else {
              icon.classList.remove('fas');
              icon.classList.add('far');
              icon.style.color = '#ccc';
            }
          });
        }

        // =======================
        //   ë¦¬ë·° ë¡œì»¬ìŠ¤í† ë¦¬ì§€
        // =======================
        function loadReviews() {
          try {
            const data = localStorage.getItem(REVIEW_KEY);
            return data ? JSON.parse(data) : [];
          } catch {
            return [];
          }
        }

        function saveReviews(reviews) {
          localStorage.setItem(REVIEW_KEY, JSON.stringify(reviews));
        }

        function updateTopSummary(reviews) {
          const totalCount = reviews.length;
          let average = 0;

          if (totalCount > 0) {
            const sum = reviews.reduce((acc, curr) => acc + curr.rating, 0);
            average = (sum / totalCount).toFixed(1);
          }

          let starsHtml = '';
          for (let i = 1; i <= 5; i++) {
            if (i <= Math.round(average)) {
              starsHtml += '<i class="fas fa-star" style="color:#FFB800"></i>';
            } else {
              starsHtml += '<i class="far fa-star" style="color:#ccc"></i>';
            }
          }

          ratingSummaryEl.innerHTML = `
            ${starsHtml}
            <span style="color: #666; font-size: 0.95rem; margin-left: 8px;">
              (${average}ì  / ${totalCount}ê°œ ë¦¬ë·°)
            </span>
          `;

          sectionTitle.textContent = `ë¦¬ë·° (${totalCount}ê°œ)`;
        }

        function renderReviews() {
          const reviews = loadReviews();
          updateTopSummary(reviews);

          reviewListEl.innerHTML = '';

          if (reviews.length === 0) {
            reviewListEl.innerHTML = `
              <p class="no-review-msg" style="color:#777; padding: 30px 0; text-align:center;">
                ì²« ë²ˆì§¸ ë¦¬ë·°ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”! ğŸ³
              </p>`;
            return;
          }

          const sorted = [...reviews].reverse();

          sorted.forEach((rev) => {
            let starsHtml = '';
            for (let i = 0; i < 5; i++) {
              starsHtml +=
                i < rev.rating
                  ? '<i class="fas fa-star" style="color:#FFB800; font-size:0.8rem;"></i>'
                  : '<i class="far fa-star" style="color:#ccc; font-size:0.8rem;"></i>';
            }

            const item = document.createElement('div');
            item.className = 'review-card';

            item.innerHTML = `
              <div class="rv-header">
                <span class="rv-nickname"></span>
                <span class="rv-stars">${starsHtml}</span>
              </div>
              <div class="review-text"></div>
              <div class="rv-date">${rev.date}</div>
            `;

            item.querySelector('.rv-nickname').textContent = rev.nickname;
            item.querySelector('.review-text').textContent = rev.text;

            reviewListEl.appendChild(item);
          });
        }

        // =======================
        //   ë¦¬ë·° ë“±ë¡ ë²„íŠ¼
        // =======================
        reviewSubmitBtn.addEventListener('click', function () {
          const text = reviewInput.value.trim();

          if (!text) {
            alert('ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
          }
          if (currentSelectedRating === 0) {
            alert('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
            return;
          }

          // ğŸ”¹ nn_nickname ì‚¬ìš© X, currentUser ê¸°ë°˜ìœ¼ë¡œ ë‹‰ë„¤ì„ ê²°ì •
          let nickname;
          if (currentUserInfo && currentUserInfo.nickname) {
            // ë¡œê·¸ì¸ + ë‹‰ë„¤ì„ ìˆëŠ” ê²½ìš°: ë‹‰ë„¤ì„ë§Œ ì‚¬ìš©
            nickname = currentUserInfo.nickname;
          } else if (currentUser) {
            // ì•„ì´ë””ë§Œ ìˆëŠ” ì´ìƒí•œ ìƒíƒœë©´ ì•„ì´ë””ë¡œ í‘œì‹œ
            nickname = '@' + currentUser;
          } else {
            // ë¡œê·¸ì¸ ì•ˆ í•œ ê²½ìš°
            nickname = 'ìµëª… ìš”ë¦¬ì‚¬';
          }

          const today = new Date();
          const dateStr = `${today.getFullYear()}-${String(
            today.getMonth() + 1
          ).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

          const newReview = {
            id: Date.now(),
            nickname,
            text,
            rating: currentSelectedRating,
            date: dateStr,
          };

          const reviews = loadReviews();
          reviews.push(newReview);
          saveReviews(reviews);

          renderReviews();

          reviewInput.value = '';
          currentSelectedRating = 0;
          updateStarVisuals(0);
        });

        // ì´ˆê¸° ë Œë”ë§
        updateSaveButton();
        renderReviews();
      });
    </script>

  </body>
</html>
